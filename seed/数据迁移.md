## 数据迁移

从pg迁移到cassandra



### 1. 迁移历史数据（3个月）

需要解决的问题：partition及ttl

cassandra 的数据表中有partition列，默认是数据中ts所在月的第一天的毫秒时间戳，

需要从pg中转换，pg的表没有partition



ttl为请求时传入，需要确认配置位置

 

### 2. 双写

需要解决的问题：双写

- 方案1：新启动一个tb服务（包含新数据库），tb-gateway 同时向新旧tb发送数据
- 方案2：修改tb代码，同时向pg和cassandra写入数据



### 3. 迁移增量数据

确认开始和结束的时间戳，使用第一步的方式迁移增量范围数据



### 4. 修改为cassandra读

确认数据无问题之后，修改tb为cassandra读



### 5. 关闭postgre写入

确认数据没有问题之后，关闭postgre写入，对应第二步







common data 更新了设备表基础字段，增加entity_area_id（实体区域id）列，对应接口中的entityAreaId，目前已经部署到test环境，

影响接口范围为 获取设备属性 和 获取实体属性 相关接口，外层返回值中增加了“entityAreaId”：

common data service 中获取设备属性和获取实体属性相关的接口，在最外层增加了“entityAreaId”，表示设备所属区域，已经部署到test环境。